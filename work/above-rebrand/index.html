<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NIR Satellite Signals → Orange Juice Yield? Yes</title>
  <meta name="description" content="Using near‑infrared ESA satellite data to predict harvest timing and disease prevalence in São Paulo orange orchards; includes naive factor model vs detection algorithm, NDVI time‑lapse, and market context."/>
  <link rel="icon" href="favicon.png" />

  <!-- MathJax for equations (only needed for the filter math block) -->
  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Leaflet for the interactive map (remove if you prefer a static image) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    /* ------- Minimal reset ------- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.6 ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:#0f0f10;background:#fff}
    img{max-width:100%;display:block;height:auto}
    a{color:inherit}
    :root{
      --max: 1080px;          /* content max width */
      --gutter: clamp(16px, 4vw, 32px);
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --border: 1px solid rgba(0,0,0,.08);
      --accent: #111;         /* tweak if you want a color pop */
      --muted: #6b7280;
    }

    /* ------- Layout ------- */
    .wrap{max-width:var(--max);margin:0 auto;padding:0 var(--gutter)}
    header.site{padding:20vh var(--gutter) 10vh;position:relative}
    header.site h1{font-size:clamp(32px,7vw,64px);line-height:1.05;margin:0 0 .6rem;font-weight:700;letter-spacing:-.02em}
    .lede{font-size:clamp(18px,2.4vw,22px);color:var(--muted);max-width:70ch;margin:0}
    .back{display:none}
    .back-fixed{position:fixed;top:16px;left:16px;z-index:10000;color:#fafafa;text-decoration:none;font-family:"BasisGrotesque-Regular",sans-serif;font-size:.888rem;letter-spacing:.02em;mix-blend-mode:exclusion;padding:4px 6px}
    .back-fixed:focus{outline:2px solid #ffd300;outline-offset:2px}
    @media (max-width:543.98px){.back-fixed{top:12px;left:12px;font-size:.777rem}}

    nav.toc{position:sticky;top:0;background:linear-gradient(#fff,rgba(255,255,255,.85));backdrop-filter:saturate(150%) blur(6px);border-bottom:var(--border);z-index:10}
    nav.toc .wrap{display:flex;gap:1rem;overflow:auto;scrollbar-width:none}
    nav.toc .wrap::-webkit-scrollbar{display:none}
    nav.toc a{display:flex;align-items:center;gap:.6rem;padding:1rem .75rem;text-decoration:none;white-space:nowrap;border-bottom:2px solid transparent}
    nav.toc a:is(:hover,:focus){border-color:#000}
    nav.toc a span.num{display:inline-grid;place-items:center;width:1.7rem;height:1.7rem;border-radius:50%;border:1px solid rgba(0,0,0,.15);font-size:.9rem}

    main section{padding:10vh 0;border-bottom:var(--border)}
    main section:last-of-type{border-bottom:none}

    /* ------- Typography helpers ------- */
    h2.section-title{font-size:clamp(22px,3.5vw,32px);letter-spacing:-.01em;margin:0 0 1rem}
    .eyebrow{display:flex;align-items:center;gap:.6rem;color:var(--muted);text-transform:uppercase;font-size:.8rem;letter-spacing:.12em}
    .eyebrow .dot{width:6px;height:6px;border-radius:50%;background:#000;opacity:.3}
    .kicker{color:var(--muted)}

    /* ------- Figures / images ------- */
    figure{margin:2rem 0;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#f8f8f8;border:var(--border)}
    figure.nochrome{border:none;box-shadow:none;background:transparent}
    figcaption{padding:.75rem 1rem;color:var(--muted);font-size:.9rem}

    .full-bleed{width:100vw;margin-left:calc(50% - 50vw)}
    .full-bleed img{width:100%;height:clamp(40vh,70vh,84vh);object-fit:cover}

    .grid{display:grid;gap:clamp(12px,2vw,20px)}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .news-grid{display:grid;gap:clamp(14px,2vw,22px);grid-template-columns:1fr 1fr}
    @media (max-width:767px){.news-grid{grid-template-columns:1fr}}
    .news-card{background:rgba(15,22,36,0.78);color:#f8fafc;border-radius:var(--radius);padding:clamp(16px,3vw,24px);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:0.75rem}
    .news-card time{font-size:.75rem;color:rgba(248,250,252,0.7);letter-spacing:.05em;text-transform:uppercase}
    .news-card a{color:#facc15;text-decoration:none;font-weight:600;line-height:1.4}
    .news-card a:hover{text-decoration:underline}
    .news-error{padding:1rem;border-radius:var(--radius);background:#111827;color:#f87171;font-size:.9rem}
    @media (max-width:900px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    /* ------- Code / math blocks ------- */
    pre{padding:1rem;border-radius:12px;background:#0f0f10;color:#f1f5f9;overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* ------- Reveal on scroll ------- */
    .reveal{opacity:0;transform:translateY(12px);transition:opacity .6s ease,transform .6s ease}
    .reveal.in{opacity:1;transform:none}

    /* ------- Lightbox ------- */
    dialog#lightbox{padding:0;border:none;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    dialog#lightbox::backdrop{background:rgba(0,0,0,.65)}
    .lightbox-img{max-width:90vw;max-height:85vh;display:block}
    .lb-close{position:absolute;inset:10px 14px auto auto;border:none;background:#fff;border-radius:999px;width:40px;height:40px;box-shadow:var(--shadow);font-weight:700;cursor:pointer}

    footer{padding:12vh var(--gutter) 16vh;color:var(--muted)}

    /* ------- Hover subpage (math/details) ------- */
    .proof-trigger{color:var(--accent); text-decoration:underline; cursor:pointer}
    .proof-box{position:fixed; left:50%; top:8vh; transform:translateX(-50%) translateY(-8px); width:min(1100px,92vw); max-height:80vh; overflow:auto; background:#fff; border:var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); padding:18px; opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; z-index:10001}
    .proof-box.open{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0)}
    .proof-close{position:sticky; top:0; margin:-6px -6px 12px auto; display:inline-block; border:none; background:#fff; border-radius:999px; width:36px; height:36px; box-shadow:var(--shadow); font-weight:700; cursor:pointer}

    /* Map */
    #map{height:60vh; border-radius:16px; overflow:hidden; box-shadow:var(--shadow); border:var(--border)}

    /* Two-option cards */
    .cards{display:grid; gap:clamp(12px,2vw,20px); grid-template-columns:1fr 1fr}
    @media (max-width:900px){.cards{grid-template-columns:1fr}}
    .card{border:var(--border); border-radius:16px; box-shadow:var(--shadow); padding:1.25rem; background:#fff}
    .card h3{margin:.2rem 0 0; font-size:1.25rem}
    .chip{display:inline-block; padding:.2rem .6rem; border-radius:999px; background:#f1f5f9; font-size:.8rem; color:#374151}

    /* Nice hero number labels like reference */
    .num-tag{display:inline-grid; place-items:center; width:1.8rem; height:1.8rem; border-radius:50%; border:1px solid rgba(0,0,0,.15); font-size:.9rem; margin-right:.5rem}
  </style>
</head>
<body>
  <a class="back-fixed" href="../../index.html"><span>←</span> Back to projects</a>
  <header class="site wrap">
    <h1>Predicting Orange Juice Production with NIR Satellites</h1>
    <p class="lede">ESA near-infrared (NIR) imaging to forecast harvest timing and detect citrus greening in São Paulo, Brazil .</p>
  </header>

  <!-- Sticky section index -->
  <nav class="toc">
    <div class="wrap">
      <a href="#tldr"><span class="num">1</span> TL;DR</a>
      <a href="#market"><span class="num">2</span> Market Context</a>
      <a href="#method"><span class="num">3</span> Method</a>
      <a href="#map"><span class="num">4</span> Fields Map</a>
      <a href="#parallel"><span class="num">5</span> Parallel Loader</a>
      <a href="#naive"><span class="num">6</span> Naive Model</a>
      <a href="#filter"><span class="num">7</span> Filtering</a>
      <a href="#results"><span class="num">8</span> Results</a>
      <a href="#demos"><span class="num">9</span> Demos</a>
      <a href="#conclusion"><span class="num">10</span> Conclusion</a>
    </div>
  </nav>

  <main>
    <!-- HERO full‑bleed image -->
    <section id="hero" class="full-bleed">
      <figure class="nochrome">
        <!-- Replace hero.jpg with your best cover image (2000px+ recommended) -->
        <img class="zoomable" src="../../wp-content/uploads/Satellite/nearAraquaba16_2023-01-01_2023-12-31_nir.gif" alt="NIR/NDVI orchard montage" loading="eager" decoding="async" />
      </figure>
    </section>

    <section id="tldr" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Summary</span></div>
      <h2 class="section-title">1 — TL;DR</h2>
      <p><strong>Idea:</strong> Use ESA NIR bands and NDVI to estimate <em>harvest timing</em> and <em>citrus greening prevalence</em> across mapped orchards in São Paulo.</p>
      <ul>
        <li><strong>Naive baseline:</strong> a factor model on market/seasonality for OJ prices.</li>
        <li><strong>Detection path:</strong> NDVI‑based field‑level signals feeding a classifier; includes a GIF of the per‑field evolution.</li>
        <li><strong>Why it matters:</strong> Leading OJ reports drop around <em>September/December</em>; satellites give ~<em>2‑month</em> lead on harvest progress.</li>
      </ul>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/nearAraquaba16_2023-01-01_2023-12-31_nir.gif" alt="NDVI field evolution GIF" loading="lazy"/>
          <figcaption>NDVI evolution for a representative field (click to zoom).</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/flowchart.png" alt="Detection algorithm flow" loading="lazy"/>
          <figcaption>Detection algorithm at a glance.</figcaption>
        </figure>
      </div>
    </section>

    <section id="market" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Context</span></div>
      <h2 class="section-title">2 — Market Context</h2>
      <p class="kicker">Current state of the OJ market &mdash; framing the question: <em>When does the bubble burst?</em></p>
      <p>The orange juice market is quite small with approximately $1M traded daily, thus classed as an "illiquid" market. It was introduced in 1966 by the New York Cotton Exchange to allow farmers to hedge against price volatility caused by weather, crop diseases, and supply-demand shifts.</p>
      <p>Over recent years, the OJ market has significantly changed. In the beginning, OJ market had predominately two main producing countries: US and Brazil. Due to various reasons, the Florida orchards, which is the main producing area in the US, reduced significantly. Currently, the Brazil area stands for >80% of the worlds OJ-production. </p>
      <p>Alright, now it becomes interesting. In Brazil, there is an area, just northwest of Sao Paulo (major city in Brazil), called the <strong>citrus belt</strong>. This consists of a couple of municipalities with all of them contributing heavily to the OJ production. </p>
      <p class="kicker"><strong>Market Overview</strong>
       If you think the OJ market sounds is interesting, I've shared a quick market overview, hover over <strong><a href="#" class="proof-trigger" aria-controls="proof-box-market" aria-expanded="false">here</a></strong>.</p>
      </div>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/stock_chart_oni.png" alt="OJ Futures + ONI Index chart" loading="lazy"/>
          <figcaption>OJ Futures + ONI Index chart.</figcaption>
        </figure>
        <div id="orange-news" class="news-grid" aria-live="polite"></div>
      </div>

      <aside id="proof-box-market" class="proof-box" aria-hidden="true">
        <button class="proof-close" aria-label="Close">×</button>

      <!-- Box 1 -->
      <div style="border:1px solid #eee;border-radius:12px;padding:14px;margin:18px 0;">
        <strong>Commodity Theory </strong>
        <div>
          Now that we have the necessary facts about the market. Let's make a trading argument from what we have: 
          So for the argument to be stringent, we know that production is necessary. 
          No oranges, no orange juice. We also have to look at demand (but for now, let's assume that it is constant). 
          Also, in commodity theory, we also pay a risk premium. 
          If the stock of oranges drops, the chance of a supply limit for OJ rises and the underlying OJ price naturally goes up. 

          <em>Why:</em> If the stock of oranges drops, the chance of a supply limit for OJ rises and the underlying OJ price naturally goes up.
        </div>
      </div>
      <div style="border:1px solid #eee;border-radius:12px;padding:14px;margin:18px 0;">
        <strong>Focusing on supply</strong>
        <div>
          Okay so focusing on supply, if we could know exactly how many oranges produced, then we would would also have exact knowledge of supply. 
          Since OJ (FCOJ, frozen concentrated orange juice) can be stored, we would also be able to know of the stock premium we have to pay, still assuming that demand is constant. 
          But how do we know that information? Luckily, there is a non profit organinsation, Fundecitrus, who supplies the world with bimonthy or quarlerly updates of Orange production in the Sao Paoulo area. 
          They get the number basically by going around and knocking on the orange framers doors, asking them about their production. 
          Naturally, they  have sophisticated tools to predict the OJ production, and every year in May/June, they predict what the OJ prodction will be the next year. 
          Historically, their predictions have been extremely close to the actual production. Other than Fundecitrus, there are two other main sources of information: Rabobank and US Treasury. Rabobank has a team in Brazil for beverages and have YoY been successful in trading OJ, similary, the US treasury gives out market predictions in a similar way.
          Essentially, they both come up with publish market reports and predictions at least every year. 

        </div>
      </div>
      <div style="border:1px solid #eee;border-radius:12px;padding:14px;margin:18px 0;">
        <strong>Reason for crazy OJ price </strong>
        <div>
          Now, back to the original question. Why has the OJ price gone up? Well, there are two main contributors to the upswing. 
          Firstly, in recent years, orange orchards have been defected with a discease called <strong>Orange greening</strong>. 
          This discease makes oranges green and small, decreasing production. According to Fundecitrus and Rabobank, the predicted orange greening will be over 60% in upcoming years. 
          The other notable thing is the El Nino. This is the South American storm that basically makes everything hotter and introduces heavy rainfall. 
          This comes every couple of years but has for the past years been very prominent. Due to mainly these two reasons, the OJ price have trampolined in the past two years.
        </div>
      
    </section>

    <section id="method" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Setup</span></div>
      <h2 class="section-title">3 — Method Overview </h2>
      <p>There are two main things we can find out using satellite images: 
        1. Greening‑stressed trees reduce chlorophyll production, altering reflectance: NIR rises while red band behavior shifts, making stressed vs healthy trees separable via vegetation indices (e.g., NDVI).
        2. Most importantly, right after the oranges have been harvested, the trees become stressed, shreading a heavy amount of leaves. If the oranges are harvested at approximately the same time of the year, this will result in a dip in i.e. NDVI charts.</p>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/nir_image.png" alt="NIR/Red band reflectance diagram" loading="lazy"/>
          <figcaption>Near infrared light (NIR) sits just by the visible light spectrum.</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/comparing_ndvi.png" alt="NIR/Red band reflectance diagram" loading="lazy"/>
          <figcaption>Idea: NIR changes as trees' leaves change chlorophyll content  &rarr; NDVI (index derived from NIR) for identification stressed fields.</figcaption>
        </figure>
      </div>
      <ul>
        <li><strong>Data:</strong> ESA Sentinel imagery (~10–15 m) with NIR and Red bands.</li>
        <li><strong>Scope:</strong> 87 mapped orchards across São Paulo state.</li>
        <li><strong>Goal:</strong> Harvest progress curve.</li>
      </ul>
    </section>

    <section id="fields" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Map</span></div>
      <h2 class="section-title">4 — Interactive Fields Map</h2>
      <p>Explore the 87 orchards (you have to zoom in a bit to actually see the fields).</p>
      <div id="map" class="reveal"></div>
      <figcaption class="wrap" style="color:var(--muted);margin-top:.5rem"> This is basically the data I collected</figcaption>
    </section>

    <section id="parallel" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Engineering</span></div>
      <h2 class="section-title">5 — Parallelizing the Pipeline</h2>
      <p class="kicker">API pulls were the bottleneck &mdash; so I <strong><a href="#" class="proof-trigger" aria-controls="proof-box-pipeline" aria-expanded="false"> fanned them out</a></strong></p>
      <aside id="proof-box-pipeline" class="proof-box" aria-hidden="true">
        <button class="proof-close" aria-label="Close">×</button>
        <div style="border:1px solid #eee;border-radius:12px;padding:14px;margin:18px 0;">
        <strong>Explaining Thread Pooling</strong>
        <div>
          You first split the big job (compute indices for many ROIs across many time windows) into independent, tiny tasks of the form (roi_name, roi, start_interval, end_interval).
          Each task is network-bound (most time is spent waiting on Earth Engine's remote calls like .getInfo()), so Python threads can overlap that waiting time. A ThreadPoolExecutor(i.e. max_workers=24) acts like a small "team" of workers: you submit all tasks at once, 
          each worker repeatedly pulls a task, runs process_interval(...) (builds server-side EE graph → triggers a small scalar result).
        </div>
      </aside>

      <pre><code>// Pseudocode sketch 
B := batch_size  // ~ W or small multiple of W

for batch in chunk(tasks, B):
    // schedule
    futures := [ pool.submit(PROCESS_INTERVAL, t) for t in batch ]

    // await all in the batch
    for f in wait_all(futures):
        out := f.result()
        if out != NONE:
            results.append(out)
</code></pre>
    </section>


    <section id="filter" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Signal Processing</span></div>
      <h2 class="section-title">6 — Looking at the Data &amp; Filtering</h2>
      <p>This is noisy! And of course, for time series we we don't use band pass filters, but Butterworth (Notch) filters.</p>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/raw_orange_data.png" alt="Raw data" loading="lazy">
          <figcaption>Raw and mean NDVI data</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Satellite/smoothed_orange_data.png" alt="Zero-lag smoothed data" loading="lazy">
          <figcaption>Zero-lag smoothed data.</figcaption>
        </figure>
      </div>
      <p class="kicker">Note that we used a zero-lag filter. I read about this filter in the book Cycle Analysis for Traders by John Ehler. Because it is zero-lag, we are essentially able to capture changes in the data quickly. For comparison, a normal moving average has a lag of (N+1)/2. In the book, Ehler doesn't go very deep on why you can't use a simple band pass filter. Curious why classic band‑pass breaks? Hover over <strong><a href="#" class="proof-trigger" aria-controls="proof-box-filter" aria-expanded="false">here</a></strong>.</p>
      <aside id="proof-box-filter" class="proof-box" aria-hidden="true">
        <button class="proof-close" aria-label="Close">×</button>

      <!-- Box 1 -->
      <div style="border:1px solid #eee;border-radius:12px;padding:14px;margin:18px 0;">
        <h3 style="margin-top:0">Why you can’t band‑pass irregular temporal data</h3>
        A classic band-pass assumes a stationary spectrum, so filtering acts as 
        \(Y(\omega) = H(\omega)X(\omega)\). When dominant frequencies drift, this 
        assumption breaks—phase shifts accumulate and ringing appears. 
        The Butterworth response,
        \( |H(\omega)|^2 = \frac{1}{1 + (\omega/\omega_c)^{2n}} \),
        is smooth and monotonic, giving stable attenuation even as the spectrum evolve. 
        In zero-phase form \(H_{zp}(\omega) = |H(\omega)|^2\), it stays symmetric and nearly lag-free.</p>      
      </div>

    </section>

    <section id="results" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Findings</span></div>
      <h2 class="section-title">8 — Conclusion</h2>
      <p>Signals line up with the main harvest window (Sep–Nov). NDVI slope reversals flag harvest onset; plateau levels track progress.</p>
      <p><strong>What does this mean for us?</strong>
      This is actually great information. Looking back when we talked about how credible Fundecitrus was, the key thing to remember is that they only report quarterly (sometimes bimonthly). In that report, they provide results about harvesting. </p>
      <p> In our case, if the report is available in December, but the harvesting was made in September, we have <strong>up to a three month head start</strong> over analysts and traders! And that's also the trading thesis! </p>
      <p>So now we just have to identify the dips. Here, the question rather becomes which approach to use: quantitative vs qualitative? I'd say that both work, but since our use case would be: "Is the harvest early or late?" qualitatively works fine for once!</p>
    </section>

    <section id="demos" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Try It</span></div>
      <h2 class="section-title">9 — <strong>Work In Progress </strong>Two Clickable Paths</h2>
      <div class="cards reveal">
        <a class="card" href="#demo-detect">
          <span class="chip">Detection</span>
          <h3><span class="num-tag">A</span> Algorithm for Better Detection</h3>
          <p>NDVI features → classifier → harvest onset &amp; greening prevalence. Includes GIF and per‑field thumbnails.</p>
        </a>
        <a class="card" href="#demo-naive">
          <span class="chip">Baseline</span>
          <h3><span class="num-tag">B</span> Naive Factor Model for Commodity Prediction</h3>
          <p>Seasonal/market factors with field means → OJ price regression/backtest.</p>
        </a>
      </div>
    </section>

    <section id="conclusion" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Wrap‑up</span></div>
      <h2 class="section-title">10 — Wrap-Up</h2>
      <ul>
        <li>Satellites provide a cheap, timely harvest progress proxy &amp; disease signal.</li>
        <li>Detection algo outperforms naive mean‑of‑field in timing precision.</li>
        <li>Practical edge: ~2‑month lead vs conventional reporting cycles.</li>
      </ul>
      <p><em>Next:</em> finer cloud‑gap handling, per‑orchard calibration, and fusing weather/radar bands.</p>
    </section>
  </main>

  <footer class="wrap">
    <p>© Your Name — <a href="#">Download PDF</a> · <a href="#">Contact</a></p>
  </footer>

  <!-- Lightbox dialog -->
  <dialog id="lightbox">
    <button class="lb-close" aria-label="Close">×</button>
    <img class="lightbox-img" src="images/hero_orchard.jpg" alt="Expanded view" />
  </dialog>

  <script>
    // Reveal on scroll
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('in');});
    }, {threshold: .08});
    document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

    // Simple lightbox using <dialog>
    const lb = document.getElementById('lightbox');
    const lbImg = lb.querySelector('.lightbox-img');
    const closeLb = ()=> lb.close();
    document.addEventListener('click', (e)=>{
      const t = e.target.closest('.zoomable');
      if(!t) return;
      e.preventDefault();
      lbImg.src = t.currentSrc || t.src;
      lb.showModal();
    });
    lb.querySelector('.lb-close').addEventListener('click', closeLb);
    lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLb(); });

    // Hover/click math boxes (supports multiple sections)
    (function(){
      const triggers = document.querySelectorAll('.proof-trigger');
      if(!triggers.length) return;

      const registry = new Map();

      triggers.forEach(trigger => {
        const targetId = trigger.getAttribute('aria-controls');
        const box = targetId ? document.getElementById(targetId) : null;
        if(!box) return;
        const close = box.querySelector('.proof-close');

        const setOpen = (open) => {
          box.classList.toggle('open', open);
          box.setAttribute('aria-hidden', String(!open));
          trigger.setAttribute('aria-expanded', String(!!open));
        };

        registry.set(box, setOpen);

        trigger.addEventListener('click', (e) => {
          e.preventDefault();
          setOpen(!box.classList.contains('open'));
        });

        trigger.addEventListener('mouseenter', () => setOpen(true));
        box.addEventListener('mouseleave', () => setOpen(false));
        if(close) close.addEventListener('click', () => setOpen(false));
      });

      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
          registry.forEach(fn => fn(false));
        }
      });
    })();

    // Leaflet map setup (replace GeoJSON path with your file)
    (function(){
      const el = document.getElementById('map');
      if(!el || typeof L === 'undefined') return;
      const map = L.map('map', {scrollWheelZoom:false}).setView([-22.5, -47.5], 7); // São Paulo region, closer zoom
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution: '© OpenStreetMap'}).addTo(map);
      // Load your GeoJSON of fields (polygons or points). Example skeleton shown inline:
      fetch('../../wp-content/uploads/Satellite/orange_fields.geojson')
        .then(r=>r.json())
        .then(geo => {
              const overrides = [
  {
    "name": "roi1",
    "color": "#0f766e",
    "weight": 0.4
  },
  {
    "name": "roi2",
    "color": "#2563eb",
    "weight": 0.4
  },
  {
    "name": "roi3",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "roi4",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "roi5",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "roi6",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "roi7",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "golf1",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "golf2",
    "color": "#eab308",
    "weight": 0.4
  },
  {
    "name": "golf3",
    "color": "#ef4444",
    "weight": 0.54
  },
  {
    "name": "golf4",
    "color": "#0f766e",
    "weight": 0.4
  },
  {
    "name": "golf5",
    "color": "#2563eb",
    "weight": 0.4
  },
  {
    "name": "golf6",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "golf7",
    "color": "#d946ef",
    "weight": 0.62
  },
  {
    "name": "golf8",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "golf9",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "aboveGolf1",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "aboveGolf2",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "aboveGolf3",
    "color": "#eab308",
    "weight": 0.4
  },
  {
    "name": "randomArea",
    "color": "#ef4444",
    "weight": 0.4
  },
  {
    "name": "citrosucoOrchard",
    "color": "#0f766e",
    "weight": 0.4
  },
  {
    "name": "citrosuco2",
    "color": "#2563eb",
    "weight": 0.4
  },
  {
    "name": "citrosuco3",
    "color": "#d97706",
    "weight": 0.52
  },
  {
    "name": "belowCitro",
    "color": "#d946ef",
    "weight": 0.43
  },
  {
    "name": "brancoPeres",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "random2",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "fazFenixX",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "random2",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "fazFenixX",
    "color": "#eab308",
    "weight": 0.4
  },
  {
    "name": "new1",
    "color": "#ef4444",
    "weight": 0.65
  },
  {
    "name": "new2",
    "color": "#0f766e",
    "weight": 0.4
  },
  {
    "name": "new3",
    "color": "#2563eb",
    "weight": 0.4
  },
  {
    "name": "new4",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "new5",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "new6",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "new7",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "new8",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "new9",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "new10",
    "color": "#eab308",
    "weight": 0.56
  },
  {
    "name": "new11",
    "color": "#ef4444",
    "weight": 0.4
  },
  {
    "name": "new12",
    "color": "#0f766e",
    "weight": 0.46
  },
  {
    "name": "new13",
    "color": "#2563eb",
    "weight": 0.49
  },
  {
    "name": "new14",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "new15",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "new16",
    "color": "#14b8a6",
    "weight": 0.88
  },
  {
    "name": "new17",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "new18",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "new19",
    "color": "#22c55e",
    "weight": 0.53
  },
  {
    "name": "new20",
    "color": "#eab308",
    "weight": 0.4
  },
  {
    "name": "new21",
    "color": "#ef4444",
    "weight": 0.4
  },
  {
    "name": "new22",
    "color": "#0f766e",
    "weight": 0.4
  },
  {
    "name": "new23",
    "color": "#2563eb",
    "weight": 0.4
  },
  {
    "name": "new24",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "new25",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "new26",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "new27",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "new28",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "new29",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba1",
    "color": "#eab308",
    "weight": 0.42
  },
  {
    "name": "nearAraquaba2",
    "color": "#ef4444",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba3",
    "color": "#0f766e",
    "weight": 0.81
  },
  {
    "name": "nearAraquaba4",
    "color": "#2563eb",
    "weight": 0.56
  },
  {
    "name": "nearAraquaba5",
    "color": "#d97706",
    "weight": 0.51
  },
  {
    "name": "nearAraquaba6",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba7",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba8",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba9",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba10",
    "color": "#22c55e",
    "weight": 0.55
  },
  {
    "name": "nearAraquaba11",
    "color": "#eab308",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba12",
    "color": "#ef4444",
    "weight": 1.15
  },
  {
    "name": "nearAraquaba13",
    "color": "#0f766e",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba14",
    "color": "#2563eb",
    "weight": 0.42
  },
  {
    "name": "nearAraquaba15",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba16",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba17",
    "color": "#14b8a6",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba18",
    "color": "#f43f5e",
    "weight": 0.44
  },
  {
    "name": "nearAraquaba19",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba20",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba21",
    "color": "#eab308",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba22",
    "color": "#ef4444",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba23",
    "color": "#0f766e",
    "weight": 0.41
  },
  {
    "name": "nearAraquaba24",
    "color": "#2563eb",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba25",
    "color": "#d97706",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba26",
    "color": "#d946ef",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba27",
    "color": "#14b8a6",
    "weight": 0.51
  },
  {
    "name": "nearAraquaba28",
    "color": "#f43f5e",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba29",
    "color": "#8b5cf6",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba30",
    "color": "#22c55e",
    "weight": 0.4
  },
  {
    "name": "nearAraquaba31",
    "color": "#eab308",
    "weight": 0.4
  }
];
          const overrideMap = overrides.reduce((acc, item) => {
            if(item && item.name) acc[item.name] = item;
            return acc;
          }, {});
          const layer = L.geoJSON(geo, {
            style: (feature) => {
              const name = feature?.properties?.name;
              const ov = name ? overrideMap[name] : null;
              const color = ov?.color || '#2563eb';
              const weight = ov?.weight || 0.8;
              return {
                color,
                weight,
                fillColor: color,
                fillOpacity: 0.25,
                opacity: 0.9
              };
            },
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              const area = (p.area_sqkm != null && !Number.isNaN(Number(p.area_sqkm)))
                ? `Area: ${Number(p.area_sqkm).toFixed(3)} km²`
                : 'Area: n/a';
              l.bindPopup(`<strong>${p.name||'Field'}</strong><br/>${area}`);
            }
          });
          layer.addTo(map);
          try{ map.fitBounds(layer.getBounds(), {padding:[20,20]}); }catch(_){}
        })
        .catch(()=>{
          // Fallback demo markers if file missing
          const demo = [
            {name:'Demo Field A', lat:-23.0, lng:-47.5},
            {name:'Demo Field B', lat:-22.2, lng:-48.3},
            {name:'Demo Field C', lat:-21.8, lng:-49.0},
          ];
          demo.forEach(d=> L.marker([d.lat,d.lng]).addTo(map).bindPopup(`<strong>${d.name}</strong>`));
        });
    })();

    // Live orange juice news cards
    (function(){
      const container = document.getElementById('orange-news');
      if(!container) return;
      const endpoint = '../../wp-content/uploads/Satellite/orange_news.json';

      function render(items){
        container.innerHTML = '';
        if(!items.length){
          container.innerHTML = '<div class="news-error">No fresh news headlines right now. Check back soon.</div>';
          return;
        }
        items.forEach(item => {
          const card = document.createElement('article');
          card.className = 'news-card';
          const title = item.title || 'Orange market update';
          const link = item.link || '#';
          const pubDate = item.pubDate || '';
          let dateText = '';
          if(pubDate){
            const date = new Date(pubDate);
            if(!Number.isNaN(date.getTime())){
              dateText = date.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
            }
          }
          card.innerHTML = `
            ${dateText ? `<time datetime="${pubDate}">${dateText}</time>` : ''}
            <a href="${link}" target="_blank" rel="noopener">${title}</a>
          `;
          container.appendChild(card);
        });
      }

      fetch(endpoint)
        .then(res => res.json())
        .then(data => {
          const items = Array.isArray(data.items) ? data.items.slice(0,4) : [];
          render(items);
        })
        .catch(() => {
          container.innerHTML = '<div class="news-error">Unable to load live news. <span style="opacity:0.7">Try refreshing the page.</span></div>';
        });
    })();
  </script>
</body>
</html>
