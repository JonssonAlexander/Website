<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Combinatorially‑Symmetric Cross‑Validation — Robust Optimisation in Financial Time Series</title>
  <meta name="description" content="Evaluating combinatorially symmetric cross‑validation (CSCV) vs normal optimisation for parameter selection in financial time series; Gaussian justification, MCMC benchmark, sliding‑window tests, ranking‑vs‑survival analysis."/>
  <link rel="icon" href="favicon.png" />

  <!-- MathJax for equations -->
  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /* ------- Minimal reset ------- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.6 ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:#0f0f10;background:#fff}
    img{max-width:100%;display:block;height:auto}
    a{color:inherit}
    :root{
      --max: 1080px;
      --gutter: clamp(16px, 4vw, 32px);
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --border: 1px solid rgba(0,0,0,.08);
      --accent: #111;
      --muted: #6b7280;
    }

    /* ------- Layout ------- */
    .wrap{max-width:var(--max);margin:0 auto;padding:0 var(--gutter)}
    header.site{padding:20vh var(--gutter) 10vh;position:relative}
    header.site h1{font-size:clamp(32px,7vw,64px);line-height:1.05;margin:0 0 .6rem;font-weight:700;letter-spacing:-.02em}
    .lede{font-size:clamp(18px,2.4vw,22px);color:var(--muted);max-width:70ch;margin:0}
    .back{display:none}
    .back-fixed{position:fixed;top:16px;left:16px;z-index:10000;color:#fafafa;text-decoration:none;font-family:"BasisGrotesque-Regular",sans-serif;font-size:.888rem;letter-spacing:.02em;mix-blend-mode:exclusion;padding:4px 6px}
    .back-fixed:focus{outline:2px solid #ffd300;outline-offset:2px}
    @media (max-width:543.98px){.back-fixed{top:12px;left:12px;font-size:.777rem}}

    nav.toc{position:sticky;top:0;background:linear-gradient(#fff,rgba(255,255,255,.85));backdrop-filter:saturate(150%) blur(6px);border-bottom:var(--border);z-index:10}
    nav.toc .wrap{display:flex;gap:1rem;overflow:auto;scrollbar-width:none}
    nav.toc .wrap::-webkit-scrollbar{display:none}
    nav.toc a{display:flex;align-items:center;gap:.6rem;padding:1rem .75rem;text-decoration:none;white-space:nowrap;border-bottom:2px solid transparent}
    nav.toc a:is(:hover,:focus){border-color:#000}
    nav.toc a span.num{display:inline-grid;place-items:center;width:1.7rem;height:1.7rem;border-radius:50%;border:1px solid rgba(0,0,0,.15);font-size:.9rem}

    main section{padding:10vh 0;border-bottom:var(--border)}
    main section:last-of-type{border-bottom:none}

    /* ------- Typography helpers ------- */
    h2.section-title{font-size:clamp(22px,3.5vw,32px);letter-spacing:-.01em;margin:0 0 1rem}
    .eyebrow{display:flex;align-items:center;gap:.6rem;color:var(--muted);text-transform:uppercase;font-size:.8rem;letter-spacing:.12em}
    .eyebrow .dot{width:6px;height:6px;border-radius:50%;background:#000;opacity:.3}
    .kicker{color:var(--muted)}

    /* ------- Figures / images ------- */
    figure{margin:2rem 0;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#f8f8f8;border:var(--border)}
    figure.nochrome{border:none;box-shadow:none;background:transparent}
    figcaption{padding:.75rem 1rem;color:var(--muted);font-size:.9rem}

    .full-bleed{width:100vw;margin-left:calc(50% - 50vw)}
    .full-bleed img{width:100%;height:clamp(40vh,70vh,84vh);object-fit:cover}

    .grid{display:grid;gap:clamp(12px,2vw,20px)}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:900px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    /* ------- Code / math blocks ------- */
    pre{padding:1rem;border-radius:12px;background:#0f0f10;color:#f1f5f9;overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* ------- Reveal on scroll ------- */
    .reveal{opacity:0;transform:translateY(12px);transition:opacity .6s ease,transform .6s ease}
    .reveal.in{opacity:1;transform:none}

    /* ------- Lightbox ------- */
    dialog#lightbox{padding:0;border:none;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    dialog#lightbox::backdrop{background:rgba(0,0,0,.65)}
    .lightbox-img{max-width:90vw;max-height:85vh;display:block}
    .lb-close{position:absolute;inset:10px 14px auto auto;border:none;background:#fff;border-radius:999px;width:40px;height:40px;box-shadow:var(--shadow);font-weight:700;cursor:pointer}

    footer{padding:12vh var(--gutter) 16vh;color:var(--muted)}

    /* ------- Hover subpage for math/details ------- */
    .proof-trigger{color:var(--accent); text-decoration:underline; cursor:pointer}
    .proof-box{position:fixed; left:50%; top:8vh; transform:translateX(-50%) translateY(-8px); width:min(1100px,92vw); max-height:80vh; overflow:auto; background:#fff; border:var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); padding:18px; opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; z-index:10001}
    .proof-box.open{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0)}
    .proof-close{position:sticky; top:0; margin:-6px -6px 12px auto; display:inline-block; border:none; background:#fff; border-radius:999px; width:36px; height:36px; box-shadow:var(--shadow); font-weight:700; cursor:pointer}

    .cards{display:grid; gap:clamp(12px,2vw,20px); grid-template-columns:1fr 1fr}
    @media (max-width:900px){.cards{grid-template-columns:1fr}}
    .card{border:var(--border); border-radius:16px; box-shadow:var(--shadow); padding:1.25rem; background:#fff}
    .card h3{margin:.2rem 0 0; font-size:1.25rem}
    .chip{display:inline-block; padding:.2rem .6rem; border-radius:999px; background:#f1f5f9; font-size:.8rem; color:#374151}
    .num-tag{display:inline-grid; place-items:center; width:1.8rem; height:1.8rem; border-radius:50%; border:1px solid rgba(0,0,0,.15); font-size:.9rem; margin-right:.5rem}

    .note{padding:.75rem 1rem; border-left:4px solid #e5e7eb; background:#fafafa; border-radius:8px}
  </style>
</head>
<body>
  <a class="back-fixed" href="../../index.html"><span>←</span> Back to projects</a>
  <header class="site wrap">
    <h1>Combinatorially‑Symmetric Cross‑Validation (CSCV) for Finance</h1>
    <p class="lede">Evaluating cross‑validation algorithms for robust parameter optimisation in financial time series — and when it pays to go against the current.</p>
    <p class="lede" style="margin-top:1rem;color:#4b5563">Special thanks to Dr. Hyll Magnus for continuous feedback throughout the project. Lucky enough to be able to talk about research during my quant internship this summer.</p>
  </header>

  <!-- Sticky section index -->
  <nav class="toc">
    <div class="wrap">
      <a href="#tldr"><span class="num">1</span> TL;DR</a>
      <a href="#overview"><span class="num">2</span> Overview</a>
      <a href="#gaussian"><span class="num">3</span> Gaussian Intuition</a>
      <a href="#mcmc"><span class="num">4</span> MCMC Benchmark</a>
      <a href="#cscv"><span class="num">5</span> CSCV Method</a>
      <a href="#protocol"><span class="num">6</span> Evaluation Protocol</a>
      <a href="#results"><span class="num">7</span> Results</a>
      <a href="#speed"><span class="num">8</span> A Note on Speed</a>
      <a href="#refs"><span class="num">9</span> References</a>
    </div>
  </nav>

  <main>
    <!-- HERO full‑bleed image -->

    <section id="tldr" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Summary</span></div>
      <h2 class="section-title">1 — TL;DR</h2>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/walkforward_cross_validation(1).png" alt="Normal optimisation schematic" loading="lazy"/>
          <figcaption>Normal IS‑optimisation flow.</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/comb_sym_cv_6.png" alt="CSCV schematic" loading="lazy"/>
          <figcaption>Combinatorial CV alternative.</figcaption>
        </figure>
      </div>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/normal_opt_normalised.png" alt="Normal optimisation schematic" loading="lazy"/>
          <figcaption>Normal IS‑optimisation results.</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/Rank_surv_cscv_4_weeks_3_param.png" alt="CSCV schematic ((Apologise for the linear reg...))" loading="lazy"/>
          <figcaption>Combinatorial CV results (Apologise for the linear reg...).</figcaption>
        </figure>
      </div>
      <ul>
        <li><strong>Question:</strong> Which cross-validation approach gives more robust parameter picks for noisy markets?</li>
        <li><strong>Result:</strong> The CSCV can outperform classic IS best-pick, but is still subject to some variance.</li>
        <li><strong>Takeaway:</strong> It may be wise to <em>go against the current</em> of standard optimisation.</li>
      </ul>
    </section>

    <section id="overview" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Setup</span></div>
      <h2 class="section-title">2 — Overview</h2>
      <p>MLDP's article presents a framework to minimise backtest-overfitting, with its' flagship model "CSCV". To provide justification for this, he quotes the following: </p>
      <div class="note"><em>Fifth, we must warn the reader against applying CSCV to guide the search for an optimal strategy. That would constitute a gross misuse of our method. As Strathern eloquently put it, “when a measure becomes a target, it ceases to be a good measure.” Any counter-overfitting technique used to select an optimal strategy will result in overfitting. For example, CSCV can be employed to evaluate the quality of a strategy selection pro- cess, but PBO should not be the objective function on which such selection relies.</em></div>
      <p>But, this might not at all be the case. Let's check it out. </p>
    </section>

    <section id="gaussian" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Intuition - if we see a high number, it's probably good</span></div>
      <h2 class="section-title">3 — Why Test This? Gaussian Case</h2>
      <p>If returns were i.i.d. Gaussian and our strategy P&amp;L were linear in returns, then for parameter set \(\theta\) the expected out‑of‑sample utility \(U\) under normalisation would satisfy</p>
      <p>\[U(\theta) = \mathbb E[\hat{\mu}_\theta] - \lambda\,\mathbb E[\hat{\sigma}_\theta] \approx \mu_\theta - \lambda\,\sigma_\theta,\]</p>
      <p>and the sampling distribution of the in-sample ranking converges to the true ranking at rate \(O(1/\sqrt{n})\). Essentially, This motivates the use of MCMC: if we see  more survivors than the Gaussian benchmark, we're probably picking up structure</p>
      <p class="kicker">Note: In heignsight, if the question accounting for multiple-testing is actually "what's the probability that at least one of the parameters in a parameter set is \(\sum{(R\frac{1}{2})^n(\frac{1}{2})^{N-n}}\), which is a way higher number. I did not realise this and the results actually motivates the search for a robust optimum each combinatorial split.</p>
    </section>

    <section id="mcmc" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Benchmark</span></div>
      <h2 class="section-title">4 — Monte Carlo </h2>
      <p>Monte to simulate the "null hypothesis". </p>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/MCMC_600_6_3.png" alt="Reference survivor distribution" loading="lazy"/>
          <figcaption>Reference survivor distribution (null) (MCMC sample - 600 runs, 6 splits).</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/MCMC_100_10_5.png" alt="Reference survivor distribution" loading="lazy"/>
          <figcaption>Reference survivor distribution (null) (MCMC sample - 100 runs, 10 splits).</figcaption>
        </figure>
      </div>
    <p> Looks sort of like the maths we did \((\frac{1}{n})\), so we got just about what you need to be able to distinguish the distribution. Except for a few differences, you can essentially be happy that the maths sort of looks like what we want to and can move on. </p>
    <p> One thing to note is that the probability of a high survival score lowers as we increase splits. This is important and we will use this later. </p>
    </section>

    <section id="cscv" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Method</span></div>
      <h2 class="section-title">5 — CSCV: Combinatorial Cross‑Validation</h2>
      <p>The following workflow evolves ideas explored in the literature (e.g., Timothy Masters). Here, we evaluate a Boolean <em>survival</em> criterion across all data splits and parameter candidates and rank them using the criteria as following:</p>
      <ul>
        <li>Dataset is split into combinatorial train/test <em>sub‑datasets</em> (e.g., 54 combinations).</li>
        <li>Parameter grid examples: <code>RSI(14,2)</code>, <code>RSI(8,4)</code>, ...</li>
        <li>Thresholds: train ≥ 90th percentile among candidates; test ≥ 50th percentile.</li>
        <li>Each time a parameter passes both thresholds for a split, it earns one <strong>survival</strong>.</li>
      </ul>
      <p> Below, you can see the ranking picture from the test. Here, we minute bitcoin data between 2020-2024 because it's easily accessible, high granularity and covers a sufficient amount of market regimes.</p>
      <figure class="reveal">
        <img class="zoomable" src="../../wp-content/uploads/Quant/Rank_surv_cscv_4_weeks_3_param.png" alt="Combinatorial survival matrix" loading="lazy"/>
        <figcaption>Survival counts across 54 splits for the parameter grid (Apologise for the linear reg...).</figcaption>
      </figure>
      <p class="note">Note: Too high of a survival count can still indicate overfitting.</p>
    </section>

    <section id="protocol" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Evaluation</span></div>
      <h2 class="section-title">6 — Results</h2>
      <p>We use a walk‑forward scheme: 2 weeks per feed the combinatorial splits (train/test), then 1 week of data is held out for true OOS evaluation. Lastly, we slide forward one week and restart.</p>
      <ol>
        <li>Run CSCV on a 2 wekk window; compute <em>survival %</em> per parameter. Then, rank them internally based on the same metric. </li>
        <li>On the following week, rank all parameters with the same utility (e.g. Sharpe) as used inside CSCV.</li>
        <li>Plot OOS <em>ranking</em> (y-axis) vs <em>survival %</em> (-‑axis). Lastly compare to normal “best-IS” optimisation.</li>
      </ol>
      <div class="grid cols-2 reveal">
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/Rank_surv_cscv_4_weeks_3_param.png" alt="Ranking vs survival scatter" loading="lazy"/>
          <figcaption>Higher survival tends to correlate with better OOS ranking.</figcaption>
        </figure>
        <figure>
          <img class="zoomable" src="../../wp-content/uploads/Quant/normal_opt_normalised.png" alt="IS vs CSCV comparison" loading="lazy"/>
          <figcaption>IS best pick across windows for reference.</figcaption>
        </figure>
      </div>
      <p class="note">Because we optimise an <em>algorithm</em>, not a specific strategy, we compare candidates <em>relative to peers</em>, not absolute returns.</p>
      <p>Note: I mentioned the use of robust optimum above to minimise multiple-testing, but as we saw in the MCMC, a quick and dirty remedy for this is to use a sufficient amount of combinatorial MOsplits.</p>
    </section>


    <section id="speed" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>Engineering</span></div>
      <h2 class="section-title">8 — A Note on Speed</h2>
      <p>CSCV can be compute‑heavy. We accelerate with precomputed utilities, cached split indices, and vectorised thresholds.</p>
      <div class="grid cols-2 reveal">
        <section>
          <p class="note">
          <strong> Before</strong>
          <ul>
            <li> Python work to build train/test</li>
            <li>Per-split slicing of the full returns matrix</li>
            <li> Percentiles computed repeatedly on large arrays</li>
          </ul>
          </p>
        </section>
        <section>
          <p class="note">
          <strong> After</strong>
          <ul>
           <li>Precompute per-period aggregates once</li>
           <li>Split evaluation reduces to vectorized adds</li>
           <li>Numba JIT on the metric kernels</li>
          </ul>
          </p>
        </section> 
      </div>
      <pre><code>// Sketch: precompute & cache
splits = precompute_splits(K=num_periods, choose=num_chosen)  # cache (train_idx, test_idx)
U = precompute_chunk_stats(R, metric)  # vectorized period x params stats

for (train_idx, test_idx) in splits:    # parallel-friendly loop
    tr = score_metric(U, train_idx)     # sums/vars reduced along axis=0
    te = score_metric(U, test_idx)
    thr_tr = np.percentile(tr, percentile)
    thr_te = np.percentile(te, percentile_2)
    survivors += (tr > thr_tr) & (te > thr_te)

</code></pre>
    </section>

    <section id="refs" class="wrap">
      <div class="eyebrow"><span class="dot"></span><span>References</span></div>
      <h2 class="section-title">9 — References</h2>
      <ul>
        <li><strong>MLDP</strong> — <em>Probability of Backtest Overfitting</em> .</li>
        <li><strong>Masters, T.</strong> —  Testing and Tuning Market Trading Systems.</li>
        <li><strong>Masters, T.</strong> —  Permutation and Randomization Tests for Trading System Development</li>

      </ul>
    </section>
  </main>

  <footer class="wrap">
    <p>© Alexander Jonsson — <a href="#">Download PDF</a> · <a href="#">Contact</a></p>
  </footer>

  <!-- Lightbox dialog -->
  <dialog id="lightbox">
    <button class="lb-close" aria-label="Close">×</button>
    <img class="lightbox-img" src="images/hero_cscv.jpg" alt="Expanded view" />
  </dialog>

  <script>
    // Reveal on scroll
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('in');});
    }, {threshold: .08});
    document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

    // Simple lightbox
    const lb = document.getElementById('lightbox');
    const lbImg = lb.querySelector('.lightbox-img');
    const closeLb = ()=> lb.close();
    document.addEventListener('click', (e)=>{
      const t = e.target.closest('.zoomable');
      if(!t) return;
      e.preventDefault();
      lbImg.src = t.currentSrc || t.src;
      lb.showModal();
    });
    lb.querySelector('.lb-close').addEventListener('click', closeLb);
    lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLb(); });
  </script>
</body>
</html>
